// ======================================
// ğŸ”¥ Firestore ãƒ«ãƒ¼ãƒ«ï¼ˆ2025.11 æœ€æ–°å®‰å®šç‰ˆï¼‰
// ======================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // ğŸ§© å…±é€šé–¢æ•°
    // ==============================
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // âœ… ç®¡ç†ã‚¢ãƒ—ãƒªå°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆFirebaseAuth ã® emailï¼‰
      return request.auth.token.email == "sakauchi.pilates@gmail.com";
    }

    // ==============================
    // ğŸ‘¤ users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼‰
    // ==============================
    match /users/{userId} {
      // ç®¡ç†è€…ã¯å…¨æ¨©ã€é¡§å®¢ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
      allow read, write: if isAdmin()
                         || (isSignedIn() && request.auth.uid == userId);
    }

    // ==============================
    // ğŸ’¬ chats ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé¡§å®¢â‡„ç®¡ç†è€…ãƒãƒ£ãƒƒãƒˆï¼‰
    // ==============================
    match /chats/{chatId} {
      // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ æœ¬ä½“ï¼ˆé¡§å®¢ or ç®¡ç†è€…ã©ã¡ã‚‰ã‚‚æ›¸è¾¼å¯ï¼‰
      allow read, write: if isAdmin()
                         || (isSignedIn() && request.auth.uid == chatId);

      // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šmessages
      match /messages/{messageId} {
        allow read, write: if isAdmin()
                           || (isSignedIn() && request.auth.uid == chatId);
      }
    }

    // ==============================
    // ğŸŸ coupons ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé¡§å®¢å‘ã‘ã‚¯ãƒ¼ãƒãƒ³ï¼‰
    // ==============================
    match /coupons/{userId} {
      allow read, write: if isAdmin()
                         || (isSignedIn() && request.auth.uid == userId);
    }

    // ==============================
    // ğŸ“© contacts ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
    // ==============================
    match /contacts/{docId} {
      // ğŸ”¹ å¤–éƒ¨ï¼ˆéãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã‚‚ create ã¯è¨±å¯
      allow create: if true;

      // ğŸ”¹ é¡§å®¢æœ¬äºº or ç®¡ç†è€…ã®ã¿ read å¯
      allow read: if isAdmin()
                  || (isSignedIn() && resource.data.email == request.auth.token.email);

      // ğŸ”¹ ç·¨é›†ãƒ»å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿
      allow update, delete: if isAdmin();
    }

    // ==============================
    // ğŸ§‘â€ğŸ’¼ admins ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†ç”¨è¨­å®šï¼‰
    // ==============================
    match /admins/{adminId} {
      // ç®¡ç†è€…ã¯ read / write ä¸¡æ–¹å¯
      allow read, write: if isAdmin();

      // é¡§å®¢ã¯ read ã®ã¿ï¼ˆåº—èˆ—æƒ…å ±ãƒ»ãŠçŸ¥ã‚‰ã›é–²è¦§ãªã©ï¼‰
      allow read: if isSignedIn() && !isAdmin();
    }

    // ==============================
    // âš–ï¸ weights ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä½“é‡ãƒ»è¨˜éŒ²ï¼‰
    // ==============================
    match /weights/{uid} {
      allow read, write: if isAdmin()
                         || (isSignedIn() && request.auth.uid == uid);

      match /daily/{dayId} {
        allow read, write: if isAdmin()
                           || (isSignedIn() && request.auth.uid == uid);
      }
    }

    // ==============================
    // ğŸ‹ï¸ exerciseSheets ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æŒ‡å°æ›¸ï¼‰
    // ==============================
    match /exerciseSheets/{uid} {
      allow read, write: if isAdmin()
                         || (isSignedIn() && request.auth.uid == uid);
    }

    // ==============================
    // ğŸš« ãã®ä»–ãƒ‡ãƒ¼ã‚¿ã¯å…¨æ‹’å¦
    // ==============================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}